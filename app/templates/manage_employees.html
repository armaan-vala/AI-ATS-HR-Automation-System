<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Employees - TalentOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen p-10">

    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-indigo-400">üë• Employee Management</h1>
                <p class="text-gray-400">Add team members to allow them access.</p>
            </div>
            <a href="/dashboard" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition">‚Üê Back to Dashboard</a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <div class="md:col-span-1 bg-gray-800 p-6 rounded-xl border border-gray-700 h-fit">
                <h2 class="text-xl font-bold mb-4 text-white">Add New Member</h2>
                <form id="addEmpForm" class="space-y-4">
                    <div>
                        <label class="text-sm text-gray-400">Full Name</label>
                        <input type="text" id="empName" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white focus:border-indigo-500 outline-none" required>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Email Address</label>
                        <input type="email" id="empEmail" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white focus:border-indigo-500 outline-none" required>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">Default Password</label>
                        <input type="text" id="empPass" value="welcome123" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white focus:border-indigo-500 outline-none" required>
                    </div>
                    
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 py-2 rounded-lg font-bold transition">
                        + Add Employee
                    </button>
                </form>
                <p id="statusMsg" class="mt-3 text-center text-sm"></p>
            </div>

            <div class="md:col-span-2 bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-white">Team Members</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-gray-400 border-b border-gray-700 text-sm">
                                <th class="p-3">Name</th>
                                <th class="p-3">Email</th>
                                <th class="p-3">Role</th>
                                <th class="p-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="empList">
                            <tr><td colspan="4" class="p-4 text-center text-gray-500">Loading employees...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem("access_token");
        if (!token) window.location.href = "/login";

        // --- 1. Load Employees ---
        async function loadEmployees() {
            try {
                const res = await fetch('/api/employees/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.status === 401) {
                    window.location.href = "/login";
                    return;
                }

                const employees = await res.json();
                const tbody = document.getElementById('empList');
                tbody.innerHTML = '';

                if (employees.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">No employees found.</td></tr>';
                    return;
                }

                employees.forEach(emp => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-700 hover:bg-gray-750";
                    tr.innerHTML = `
                        <td class="p-3 font-medium text-white">${emp.full_name}</td>
                        <td class="p-3 text-gray-400">${emp.email}</td>
                        <td class="p-3"><span class="px-2 py-1 bg-green-900 text-green-300 text-xs rounded">${emp.role}</span></td>
                        <td class="p-3 text-right">
                            <button onclick="deleteEmployee(${emp.id})" class="text-red-400 hover:text-red-300 text-sm font-semibold hover:underline">Remove</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (err) { console.error(err); }
        }

        // --- 2. Add Employee ---
        document.getElementById('addEmpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const msg = document.getElementById('statusMsg');
            
            const data = {
                full_name: document.getElementById('empName').value,
                email: document.getElementById('empEmail').value,
                password: document.getElementById('empPass').value
            };

            btn.disabled = true;
            btn.innerText = "Adding...";

            try {
                const res = await fetch('/api/employees/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (res.ok) {
                    msg.innerText = "‚úÖ Employee Added!";
                    msg.className = "mt-3 text-center text-sm text-green-400";
                    document.getElementById('addEmpForm').reset();
                    loadEmployees();
                } else {
                    msg.innerText = `‚ùå ${result.detail}`;
                    msg.className = "mt-3 text-center text-sm text-red-400";
                }
            } catch (err) {
                msg.innerText = "‚ùå Network Error";
            }
            
            btn.disabled = false;
            btn.innerText = "+ Add Employee";
        });

        // --- 3. Delete Employee ---
        async function deleteEmployee(id) {
            if(!confirm("Are you sure you want to remove this employee?")) return;

            try {
                const res = await fetch(`/api/employees/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    loadEmployees();
                } else {
                    alert("Failed to delete. Only HR Admins can delete.");
                }
            } catch (err) { alert("Error deleting."); }
        }

        // Initial Load
        loadEmployees();
    </script>
</body>
</html>